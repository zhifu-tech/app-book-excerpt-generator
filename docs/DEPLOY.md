# éƒ¨ç½²æŒ‡å—

æœ¬é¡¹ç›®åŒ…å«å‰ç«¯åº”ç”¨ (app) å’Œåç«¯æœåŠ¡ (server)ï¼Œæ¨èä½¿ç”¨æ ¹ç›®å½•çš„ç»Ÿä¸€ç®¡ç†è„šæœ¬è¿›è¡Œéƒ¨ç½²ã€‚

## æœåŠ¡å™¨æ¦‚è§ˆ

- **æœåŠ¡å™¨åœ°å€**: 8.138.183.116
- **å‰ç«¯è®¿é—®åœ°å€**: `https://book-excerpt.zhifu.tech` (ç«¯å£ 80/443)
- **åç«¯ API åœ°å€**: `https://api.book-excerpt.zhifu.tech` (ç«¯å£ 3001)
- **éƒ¨ç½²ç”¨æˆ·**: root

---

## ğŸš€ ç»Ÿä¸€ç®¡ç†è„šæœ¬ (æ¨è)

æ ¹ç›®å½•ä¸‹çš„ `run.sh` è„šæœ¬æ•´åˆäº†å‰åç«¯çš„æ‰€æœ‰ç®¡ç†åŠŸèƒ½ã€‚

### åŸºæœ¬ç”¨æ³•

```bash
chmod +x run.sh
./run.sh [module] [command] [options]
```

### å¸¸ç”¨å‘½ä»¤

| æ¨¡å—       | å‘½ä»¤             | è¯´æ˜                                     |
| :--------- | :--------------- | :--------------------------------------- |
| **å…¨å±€**   | `update-ssh-key` | æ›´æ–°æœ¬åœ° SSH å…¬é’¥åˆ°æœåŠ¡å™¨                |
| **app**    | `docker-deploy`  | **(æ¨è)** ä½¿ç”¨ Docker éƒ¨ç½²å‰ç«¯åº”ç”¨      |
| **app**    | `update-nginx`   | æ›´æ–°å‰ç«¯ Nginx é…ç½®åŠ SSL è¯ä¹¦           |
| **app**    | `check`          | æ£€æŸ¥å‰ç«¯æ–‡ä»¶åŠå®¹å™¨çŠ¶æ€                   |
| **server** | `deploy`         | ä½¿ç”¨ PM2 éƒ¨ç½²åç«¯æœåŠ¡                    |
| **server** | `docker-deploy`  | ä½¿ç”¨ Docker éƒ¨ç½²åç«¯æœåŠ¡                 |
| **server** | `status`         | æ£€æŸ¥åç«¯ PM2/ç«¯å£/å¥åº·æ£€æŸ¥çŠ¶æ€           |
| **server** | `logs`           | æŸ¥çœ‹åç«¯å®æ—¶æ—¥å¿—                         |
| **server** | `sync-data`      | åŒæ­¥æœ¬åœ°ä¸æœåŠ¡å™¨çš„æ•°æ®æ–‡ä»¶ (`up`/`down`) |

---

## ğŸ“¦ å‰ç«¯éƒ¨ç½² (app)

### 1. Docker éƒ¨ç½² (æ¨è)

æ‰§è¡Œ `./run.sh app docker-deploy`ã€‚è¯¥å‘½ä»¤ä¼šï¼š

1. åœ¨æœ¬åœ°æ„å»º `amd64` æ¶æ„çš„ Docker é•œåƒã€‚
2. å°†é•œåƒå¯¼å‡ºå¹¶ä¸Šä¼ è‡³æœåŠ¡å™¨ã€‚
3. åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨å®¹å™¨å¹¶æ˜ å°„ç«¯å£ã€‚
4. è‡ªåŠ¨æ›´æ–° Nginx åå‘ä»£ç†é…ç½®ã€‚

### 2. æ‰‹åŠ¨ Nginx éƒ¨ç½²

å¦‚æœä½ ä¸ä½¿ç”¨ Dockerï¼Œå¯ä»¥å°† `app/` ä¸‹çš„é™æ€æ–‡ä»¶ç›´æ¥åŒæ­¥åˆ°æœåŠ¡å™¨ï¼š

- **ç›®å½•**: `/var/www/html/book-excerpt-generator`
- **æƒé™**: ç¡®ä¿ `nginx` ç”¨æˆ·æœ‰è¯»å–æƒé™ã€‚

---

## âš™ï¸ åç«¯éƒ¨ç½² (server)

### 1. PM2 éƒ¨ç½² (æ¨è)

æ‰§è¡Œ `./run.sh server deploy`ã€‚

- åç«¯æœåŠ¡å°†è¿è¡Œåœ¨ Node.js ç¯å¢ƒä¸‹ã€‚
- è‡ªåŠ¨å®‰è£…ä¾èµ– (`npm install --production`)ã€‚
- ä½¿ç”¨ PM2 è¿›è¡Œè¿›ç¨‹ç®¡ç†å’Œå¼€æœºè‡ªå¯ã€‚

### 2. Docker éƒ¨ç½²

æ‰§è¡Œ `./run.sh server docker-deploy`ã€‚

- æ„å»ºå¹¶ä¸Šä¼ åç«¯ Docker é•œåƒã€‚
- å®¹å™¨å†…éƒ¨è¿è¡Œåœ¨ 3001 ç«¯å£ã€‚

### 3. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `server/` ç›®å½•ä¸‹åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
PORT=3001
HOST=0.0.0.0
NODE_ENV=production
CORS_ORIGIN=https://book-excerpt.zhifu.tech
```

---

## ğŸ› ï¸ Nginx ä¸ SSL é…ç½®

é¡¹ç›®ä¸ºå‰åç«¯åˆ†åˆ«å‡†å¤‡äº†åŸŸåï¼š

- **å‰ç«¯**: `book-excerpt.zhifu.tech`
- **åç«¯**: `api.book-excerpt.zhifu.tech`

### æ›´æ–°é…ç½®

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¸Šä¼ è¯ä¹¦å¹¶é‡è½½ Nginxï¼š

```bash
./run.sh app update-nginx
./run.sh server update-nginx
```

è¯ä¹¦æ–‡ä»¶åº”æ”¾ç½®åœ¨ï¼š

- å‰ç«¯: `app/scripts/book-excerpt.zhifu.tech_nginx/`
- åç«¯: `server/scripts/api.book-excerpt.zhifu.tech_nginx/`

---

## â“ æ•…éšœæ’æŸ¥

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
./run.sh app check
./run.sh server status
```

### æŸ¥çœ‹æ—¥å¿—

```bash
./run.sh server logs 100  # æŸ¥çœ‹æœ€å100è¡Œæ—¥å¿—
```

### ç«¯å£å ç”¨ä¿®å¤

å¦‚æœ Nginx æ— æ³•å¯åŠ¨ï¼Œå°è¯•æ£€æŸ¥ 80/443 ç«¯å£ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
netstat -tlnp | grep :80
```

æˆ–ä½¿ç”¨è„šæœ¬ï¼ˆå¦‚æ—§ç‰ˆè„šæœ¬ä¸­æä¾›çš„ `fix-port` åŠŸèƒ½ï¼Œç°å»ºè®®æ‰‹åŠ¨æ£€æŸ¥ï¼‰ã€‚

---

## ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤

åç«¯ç”Ÿæˆçš„é…ç½®æ•°æ®å­˜å‚¨åœ¨ `server/data/config.json` ä¸­ã€‚

- **ä¸Šä¼ æœ¬åœ°æ•°æ®**: `./run.sh server sync-data up`
- **å¤‡ä»½æœåŠ¡å™¨æ•°æ®**: `./run.sh server sync-data down`
